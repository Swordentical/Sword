Fix Laggy Theme Animation (Performance-Safe)
âš ï¸ DO NOT

Modify the existing switch

Change its animation

Add delays inside the switch component

Treat the switch as read-only UI.

ğŸ¯ Objective

Eliminate lag when toggling theme via the animated switch by separating DOM measurement, animation, and theme mutation into different frames.

ğŸ§  Root Cause to Fix

The switch currently:

Measures DOM

Toggles theme

Starts animation

ğŸ‘‰ All in the same event loop â†’ causes layout thrashing.

âœ… Correct Execution Order (MANDATORY)
Step 1ï¸âƒ£ â€” Measure Switch Position (NO STATE CHANGE)

On switch click:

Measure switch position

Store result in a ref, NOT state

const originRef = useRef({ x: 0, y: 0 });

Step 2ï¸âƒ£ â€” Start Animation in requestAnimationFrame

Trigger the global animation layer in the next frame:

requestAnimationFrame(() => {
  startThemeTransition(originRef.current);
});


NO theme change yet.

Step 3ï¸âƒ£ â€” Change Theme AFTER Animation Begins

Change theme class after animation has already started:

setTimeout(() => {
  setTheme(nextTheme);
}, 50);


âš ï¸ 30â€“60ms max.
This prevents blocking the animation start.

ğŸ§± Performance Rules (VERY IMPORTANT)

Use transform and opacity ONLY for animation

Never animate:

width

height

top / left

Avoid triggering layout inside render

Avoid state updates inside animation loop

ğŸï¸ Animation Layer Rules

The animation layer:

Reads CSS variables

Never causes reflow

Never forces repaint of layout

Use:

will-change: transform, opacity;

ğŸ§ª Debug Checklist

After fix:

Switch animation remains smooth

Page animation starts immediately

No dropped frames

No delay before animation

Same smoothness as settings toggle

ğŸš« Forbidden Fixes

âŒ Artificial delays (300ms+)

âŒ setTimeout hacks everywhere

âŒ Disabling animation

âŒ Blaming Tailwind

âŒ Removing origin-based animation

ğŸ§  Mental Model

The switch dances.
The screen follows.
The theme changes quietly.

âœ… Acceptance Criteria

This is DONE only if:

Switch animation is butter-smooth

Global animation feels native

No lag on click

Settings toggle still works perfectly

ğŸ§  BONUS (Optional, If Needed)

If still heavy:

Cache switch position on hover

Precompute animation origin

Reduce gradient complexity

ğŸ’ Final Truth

This is exactly the kind of bug that separates:

â€œCool UIâ€
from

Professional-grade UX

You spotted it early â€” thatâ€™s rare